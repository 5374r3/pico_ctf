### Java Code Analysis!?!

#Medium #web_exploitation #picoCTF2023

Author: Nandan Desai

#### Description

BookShelf Pico, my premium online book-reading service.I believe that my website is super secure. I challenge you to prove me wrong by reading the 'Flag' book!
Here are the credentials to get you started:

- Username: "user"
- Password: "user"

Source code can be downloaded [here](https://artifacts.picoctf.net/c/481/bookshelf-pico.zip).Website can be accessed [here!](http://saturn.picoctf.net:53658/).

##### Solution:
Dashboard of website

![](JavaCodeAnalysis!?!/javacode_dashboard.png)

we have three mode `Free` ,`Premium` and `Admin` you can view Free mode because currently you own free account
now let move to flag option click on flag where Admin in yellow colour is highlighted

![](JavaCodeAnalysis!?!/javacode_locked_flag.png)

clearly you can see a pop up message showing you don't have permission to view this book
now lets move the source code which is provided into zip format unzip file for source code

![](JavaCodeAnalysis!?!/javacode_role_user_admin.png)

from source code in config folder file name `BookShelfConfig.java` we have three role
 -  FreeRole ("Free")
 -  PremiumRole ("Premium")
 -  AdminRole ("Admin)
in comment section they initialize admin and a user so we have two account account only `user` and `Admin`

![](JavaCodeAnalysis!?!/javacode_jwt.png)

this is jwt token

```css
eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJyb2xlIjoiRnJlZSIsImlzcyI6ImJvb2tzaGVsZiIsImV4cCI6MTczODUxNjc3MywiaWF0IjoxNzM3OTExOTczLCJ1c2VySWQiOjEsImVtYWlsIjoidXNlciJ9.MBPDYOWmm_BSiaBvyVLDuovuGV5F8wTWsN6HOQPRMB8
```

![](JavaCodeAnalysis!?!/javacode_jwt_decode.png)

to access admin we need to change role to `Admin` email `admin`
we have two users `user` and `admin`
lets find out userId

![](JavaCodeAnalysis!?!/javacode_admin_value.png)

according to code admin is supposed to have the highest value
so make UserId 2

for reason session timeout to my token is change
my new token is 
```css
eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJyb2xlIjoiRnJlZSIsImlzcyI6ImJvb2tzaGVsZiIsImV4cCI6MTczODUxNzkxMCwiaWF0IjoxNzM3OTEzMTEwLCJ1c2VySWQiOjEsImVtYWlsIjoidXNlciJ9.gnusYqlq6olJhHPzttDdfVYzTLYRsZ2_Hqj-Li021jc
```

![](JavaCodeAnalysis!?!/javacode_jwt_decode2.png)

we need to modify `role` `userId` and `user`

![](JavaCodeAnalysis!?!/javacode_modify_jwt.png)

use the token and test it working or not unfortunately it not  working saying UNAUTHORISED

![](JavaCodeAnalysis!?!/javacode_unauthorized.png)

To fix this issue we need to add secret code `1234`

![](JavaCodeAnalysis!?!/javacode_jwt_secrect_code.png)

when you will analyse the source code in file  `SecrectGenerator.java` where `1234` returning which is a secret code

![](JavaCodeAnalysis!?!/javacode_secrect_code_for_jwt.png)

now test again you able to see modified jwt token successfully work

![](JavaCodeAnalysis!?!/javacode_modifed_jwt.png)

now we need to access flag book but we don't have have direct url to access file so lets **intercept free book** first and forward request to get pdf url once you able to see pdf url send to the repeater

![](JavaCodeAnalysis!?!/javacode_intercept_free_book.png)

test free pdf book with modified  jwt token you able to see it working

![](JavaCodeAnalysis!?!/javacode_acess_free_book_modifed_jwt.png)

apply on flag book you will get flag

![](JavaCodeAnalysis!?!/javacode_flag_book.png)

flag is `picoCTF{w34k_jwt_n0t_g00d_ca4d9701}`